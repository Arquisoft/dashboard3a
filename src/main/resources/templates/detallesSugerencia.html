<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8"/>
	<title>Dashboard3a - Detalles sugerencia</title>
	<script src="/webjars/jquery/3.2.0/jquery.min.js"></script>
	<script src="/webjars/sockjs-client/sockjs.min.js"></script>
	<script src="/webjars/stomp-websocket/stomp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.4/Chart.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/push.js/0.0.13/push.min.js"></script>
	<script>
		$(document).ready(function() {
		var tabla = $("#tablaComentarios");
		var idSug = parseInt($("#idSugerencia").html());

		var socket = new SockJS('/stomp');

		var stompClient = Stomp.over(socket);

	    stompClient.connect({ }, function(frame) {
			stompClient.subscribe("/topic/comentarios", function(data) {
				var comentario = JSON.parse(data.body);

				if (comentario.sugerencia.id === idSug) {
					var htmlString = `
					<tr>
						<td align="center">${comentario.id}</td>
						<td>${comentario.contenido}</td>
					</tr>
					`;

					tabla.append(htmlString);

					Push.create("Nuevo comentario para " + comentario.sugerencia.titulo, {
    				body: comentario.contenido,
    				timeout: 4000,
    				onClick: function () {
        			window.focus();
        			this.close();
    				}
					});
				}
			});

			stompClient.subscribe("/topic/sugerencias", function(data) {
				var sugerencia = JSON.parse(data.body);

				if (sugerencia.id === idSug) {
						var positivosAntes = parseInt($("#votosPositivos").html());
						var negativosAntes = parseInt($("#votosNegativos").html());
						$("#votosPositivos").html(sugerencia.votosPositivos.toString());
						$("#votosNegativos").html(sugerencia.votosNegativos.toString());
						$("#votosTotales").html("" + (sugerencia.votosPositivos + sugerencia.votosNegativos));
						window.myChart.data.datasets[0].data[0] = sugerencia.votosPositivos;
						window.myChart.data.datasets[0].data[1] = sugerencia.votosNegativos;
						window.myChart.update();

						if (sugerencia.votosPositivos > positivosAntes) {
							Push.create("Voto positivo", {
		    				body: sugerencia.titulo,
		    				timeout: 4000,
		    				onClick: function () {
		        			window.focus();
		        			this.close();
		    				}
							});
						}

						if (sugerencia.votosNegativos > negativosAntes) {
							Push.create("Voto negativo", {
		    				body: sugerencia.titulo,
		    				timeout: 4000,
		    				onClick: function () {
		        			window.focus();
		        			this.close();
		    				}
							});
						}
				}
			});
	    });
	});
	</script>
</head>
<body>
	<h1>Detalles de la sugerencia</h1>
	<p>
		<a href="graficas">Visualizar graficas</a>
	</p>
	<table id="detallesSugerencia">
		<tr>
			<th>Id</th>
			<th>Titulo</th>
			<th>Fecha</th>
			<th>Votos positivos</th>
			<th>Votos negativos</th>
			<th>Votos totales</th>
		</tr>
		<tr>
			<td id="idSugerencia" th:text="${detalles.id}" align="center" />
			<td th:text="${detalles.titulo}" />
			<td th:text="${detalles.fecha}" />
			<td id="votosPositivos" th:text="${detalles.votosPositivos}" align="center" />
			<td id="votosNegativos" th:text="${detalles.votosNegativos}" align="center" />
			<td id="votosTotales" th:text="${detalles.votosTotales}" align="center" />
		</tr>
	</table>

	<h2>Valoracion media de la propuesta:</h2>
	<div th:if="${valoracion} &lt; 0.5">
		<p th:text="${valoracion}" style="color: red;"></p>
	</div>
	<div th:unless="${valoracion} &lt; 0.5">
		<p th:text="${valoracion}" style="color: green;"></p>
	</div>

	<h2>Comentarios de la propuesta</h2>
	<table id="tablaComentarios">
		<tr>
			<th>Id</th>
			<th>Comentario</th>
		</tr>
		<tr th:each="comentario : ${comentarios}">
			<td th:text="${comentario.id}" align="center" />
			<td th:text="${comentario.contenido}" />
		</tr>
	</table>
	<h2>Diagrama circular - Relaci√≥n votos</h2>
	<div id="canvas-holder" style="width:400px">
		<canvas id="myChart"></canvas>
	</div>
	<script>
	var ctx = document.getElementById("myChart").getContext('2d');
window.myChart = new Chart(ctx, {
type: 'pie',
responsive: true,
maintainAspectRatio: false,
data: {
  labels: ["Votos Positivos", "Votos Negativos"],
  datasets: [{
    backgroundColor: [
      "#2ecc71",
      "#3498db",
      "#95a5a6",
      "#9b59b6",
      "#f1c40f",
      "#e74c3c",
      "#34495e"
    ],
    data: [parseInt(document.getElementById("votosPositivos").innerHTML), parseInt(document.getElementById("votosNegativos").innerHTML)]
  }]
}
});
	</script>
</body>
</html>
